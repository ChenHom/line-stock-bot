# Feature Specification: Gugo 研究引擎整合

**Feature Branch**: `003-gugo-integration`  
**Created**: 2025-12-04  
**Status**: Draft  
**Input**: 整合 gugo 研究引擎，讓 line-stock-bot 成為「gugo 研究引擎的前端」，支援詳解、策略股等研究型指令

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 單一股票因子詳解查詢 (Priority: P1)

使用者想了解某檔股票的量化因子分析，輸入「詳解 2330」或「詳解 台積電」後，機器人回覆該股票的多因子評分與關鍵指標，讓使用者一眼看出這檔股票的優勢與風險。

**Why this priority**: 這是最基本的研究功能，讓使用者從單純查價升級到理解股票的投資價值，是整合 gugo 的核心價值展現。

**Independent Test**: 可單獨測試「詳解 2330」指令，驗證是否正確呼叫 gugo API 並回傳格式化的因子分析結果。

**Acceptance Scenarios**:

1. **Given** 使用者已開啟 LINE 對話, **When** 輸入「詳解 2330」, **Then** 機器人回覆台積電的因子評分（總分、估值、成長、品質、動能、資金流）與 1-2 個關鍵指標
2. **Given** 使用者輸入股票名稱, **When** 輸入「詳解 台積電」, **Then** 系統將名稱轉換為代碼後，回覆相同的因子分析結果
3. **Given** 使用者只輸入指令無股票, **When** 輸入「詳解」, **Then** 機器人回覆引導訊息，提示需帶代碼或名稱
4. **Given** 使用者輸入無效股票, **When** 輸入「詳解 9999」, **Then** 機器人回覆「查不到這檔股票」

---

### User Story 2 - 策略股清單查詢 (Priority: P1)

使用者想知道目前有哪些高潛力股票，輸入「策略股」或「高潛力」後，機器人回覆由 gugo 多因子模型篩選出的前 10 名股票清單，包含代碼、名稱、總分與特色標籤。

**Why this priority**: 這是 gugo 研究引擎的核心產出，讓使用者直接獲得投資參考標的，與詳解功能互補形成完整的研究體驗。

**Independent Test**: 可單獨測試「策略股」指令，驗證是否正確取得並呈現排行榜資料。

**Acceptance Scenarios**:

1. **Given** 使用者已開啟 LINE 對話, **When** 輸入「策略股」, **Then** 機器人回覆前 10 名高分股票清單（代碼、名稱、總分、標籤）
2. **Given** 使用者使用別名, **When** 輸入「高潛力」, **Then** 機器人回覆相同的策略股清單
3. **Given** gugo 排行榜無符合條件的股票, **When** 輸入「策略股」, **Then** 機器人回覆「目前無符合條件的策略股」

---

### User Story 3 - Gugo 服務異常的優雅降級 (Priority: P1)

當 gugo 服務回應過慢或發生錯誤時，機器人應提供友善的錯誤訊息，不讓使用者等待過久或看到技術性錯誤，並引導使用者使用其他功能。

**Why this priority**: 服務穩定性是用戶體驗的基礎，錯誤處理必須與核心功能同時完成，避免 gugo 故障導致整個機器人無法使用。

**Independent Test**: 可透過模擬 gugo 逾時或錯誤回應來測試降級機制。

**Acceptance Scenarios**:

1. **Given** gugo 服務回應超時, **When** 使用者查詢詳解或策略股, **Then** 機器人在設定時間內回覆「研究系統回應過慢，請稍後再試或改查基本股價」
2. **Given** gugo 服務回傳錯誤, **When** 使用者查詢詳解, **Then** 機器人回覆「暫時無法取得詳解」，並在內部記錄錯誤資訊
3. **Given** gugo 服務完全無法連線, **When** 使用者查詢策略股, **Then** 機器人回覆降級訊息，既有的股價與新聞查詢功能仍正常運作

---

### User Story 4 - 回測結果查詢 (Priority: P2)

使用者想了解某檔股票或策略的歷史回測績效，輸入「回測 0050」後，機器人回覆該標的的年化報酬率、最大回撤、勝率等關鍵績效指標。

**Why this priority**: 回測是進階功能，可在詳解與策略股穩定後再實作。回測計算較耗時，需要額外的逾時與錯誤處理考量。

**Independent Test**: 可單獨測試「回測 0050」指令，驗證是否正確呼叫 gugo 回測 API 並呈現績效摘要。

**Acceptance Scenarios**:

1. **Given** 使用者已開啟 LINE 對話, **When** 輸入「回測 0050」, **Then** 機器人回覆該標的的年化報酬率、最大回撤、勝率或 Sharpe 指標
2. **Given** 回測計算超過設定時間, **When** 使用者等待結果, **Then** 機器人回覆「回測暫時無法提供」，不讓 LINE 對話卡住

---

### Edge Cases

- 使用者在短時間內重複發送相同的研究指令時，系統如何處理？
- 使用者輸入的股票代碼格式不標準（如含 .TW 後綴）時，系統如何處理？
- 策略股清單在短時間內被多位使用者查詢時，如何避免重複呼叫 gugo？
- gugo 回傳的資料格式與預期不符時，系統如何處理？

## Requirements *(mandatory)*

### Functional Requirements

#### 基礎架構

- **FR-001**: 系統必須新增 gugo 服務的連線設定（Base URL、API Key、Timeout）
- **FR-002**: 系統必須建立統一的 gugo client 模組，集中處理所有對 gugo 的 HTTP 呼叫
- **FR-003**: gugo client 必須處理 URL 組裝、Header 設定、逾時與錯誤處理、記錄 log
- **FR-004**: 系統必須在每次 gugo 呼叫時記錄：symbol、指令類型、是否成功、耗時

#### 詳解指令

- **FR-005**: 系統必須支援「詳解 \<股票代碼\>」指令格式
- **FR-006**: 系統必須支援「詳解 \<股票名稱\>」指令格式，並複用現有的名稱→代碼轉換邏輯
- **FR-007**: 系統必須呼叫 gugo 因子評分 API 取得股票分析資料
- **FR-008**: 系統必須將 gugo 回應轉換為固定格式的 LINE 訊息（Flex 或文字）
- **FR-009**: 詳解結果必須包含：總分、五大因子分數、1-2 個關鍵指標

#### 策略股指令

- **FR-010**: 系統必須支援「策略股」與「高潛力」關鍵字觸發排行榜查詢
- **FR-011**: 系統必須呼叫 gugo 排行榜 API 取得前 10 名高分股票
- **FR-012**: 策略股清單必須包含：股票代碼、名稱、總分、特色標籤
- **FR-013**: 系統可對策略股清單做短期快取（建議 5 分鐘），避免重複呼叫 gugo

#### 回測指令（第二階段）

- **FR-014**: 系統必須支援「回測 \<股票代碼\>」指令格式
- **FR-015**: 回測結果必須包含：年化報酬率、最大回撤、勝率或 Sharpe

#### 錯誤處理

- **FR-016**: 股票代碼無效時，系統必須回覆「查不到這檔股票」
- **FR-017**: gugo 回傳錯誤時，系統必須回覆友善訊息並記錄錯誤碼
- **FR-018**: gugo 超時時，系統必須回覆「研究系統回應過慢」並建議替代方案
- **FR-019**: 所有對 gugo 的呼叫必須經過統一的錯誤處理，不讓例外影響 webhook handler

#### 監控與風險控制

- **FR-020**: 系統必須記錄各指令類型的呼叫次數、成功率、平均耗時
- **FR-021**: 系統必須實作同一使用者的指令頻率限制，防止濫用

### Key Entities

- **GugoClient**: 負責與 gugo 服務通訊的模組，處理 HTTP 請求、認證、逾時與錯誤
- **FactorScore**: 股票的因子評分資料，包含總分與各維度分數（估值、成長、品質、動能、資金流）
- **StrategyRanking**: 策略股排行榜資料，包含股票清單與各股票的分數與標籤
- **BacktestResult**: 回測結果資料，包含績效指標（報酬率、回撤、Sharpe）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者輸入詳解指令後，在 3 秒內收到完整的因子分析結果
- **SC-002**: 使用者輸入策略股指令後，在 3 秒內收到前 10 名股票清單
- **SC-003**: gugo 服務異常時，使用者在設定的逾時時間內（建議 2 秒）收到友善的降級訊息
- **SC-004**: 系統對 gugo 的呼叫成功率達到 95% 以上（排除 gugo 服務本身的故障）
- **SC-005**: 既有的股價查詢、新聞查詢功能在整合後仍正常運作，無效能下降
- **SC-006**: 同一使用者在 30 秒內重複查詢相同研究指令時，系統能正確處理（快取或限流）

## Assumptions

- gugo 服務已提供穩定的 HTTP API，包含因子評分、排行榜、回測三個端點
- gugo API 回應時間在正常情況下小於 800ms
- 股票代碼使用純數字格式（如 2330），由 line-stock-bot 負責名稱轉換
- gugo API 回傳標準化的錯誤格式（包含 errorCode 與 message）
- 使用現有的 Redis 快取基礎設施，不需要新增快取技術

## Dependencies

- gugo HTTP 服務必須先完成 API 開發（參考 `specs/001-gugo-http-service`）
- 現有的 stock-list 名稱→代碼轉換功能可直接複用
- 現有的 Redis 快取機制可直接複用

## Out of Scope

- gugo 服務的 API 實作（由 gugo 專案負責）
- 多策略選擇功能（未來版本再擴充）
- 自訂回測參數（時間區間、策略參數）
- 即時推播策略股變動通知
